# E2E Test Suite

This directory contains end-to-end tests that exercise the full LMTP → DB → IMAP pipeline using the test helpers under `test/helpers`.

## Tests included

Files and primary tests:

- `lmtp_imap_delivery_e2e_test.go` - TestE2E_LMTP_To_IMAP_ReceiveEmail (core delivery round-trip)
- `lmtp_delivery_advanced_e2e_test.go` - multiple recipients, large messages, invalid deliveries
- `imap_auth_e2e_test.go` - TestE2E_SASL_Authentication (SASL/LOGIN auth behavior)
- `imap_operations_e2e_test.go` - flags and read state tests
- `mailbox_state_e2e_test.go` - UID/UIDVALIDITY and mailbox sequence tests
- `concurrency_e2e_test.go` - concurrent delivery and fetch validations
- `persistence_e2e_test.go` - server restart + persistence tests

## Running E2E tests

From repository root you can use the Makefile targets which invoke the correct `go test` commands and patterns:

```bash
# Run entire e2e suite
make test-e2e

# Run the core delivery tests (fast)
make test-e2e-delivery

# Run IMAP-specific e2e tests
make test-e2e-imap

# Run authentication e2e tests
make test-e2e-auth

# Run concurrency-focused e2e tests
make test-e2e-concurrency

# Run persistence-focused e2e tests
make test-e2e-persistence

# Minimal essential set
make test-e2e-minimal
```

Or call `go test` directly:

```bash
# single test by name (most useful when iterating)
go test ./test/e2e -run TestE2E_LMTP_To_IMAP_ReceiveEmail -v
```

## Environment and config

The e2e tests use a small test config under `test/e2e/config/test.yaml` which is loaded by the test harness. It uses ephemeral ports and a temporary SQLite path (set by the test code). TLS is used for IMAP STARTTLS support in tests (self-signed certs generated by the helper), and the test IMAP client accepts the test cert.

## Helpful tips
- When a test fails, check logs printed by the relevant helper (LMTP/IMAP delivery logs are printed to stderr).  The e2e harness prints the ephemeral ports in the test log to help reproduce the failing run.
- Use `env.WaitDelivery()` (in the e2e helper) to wait deterministically for the delivery pipeline instead of arbitrary long sleeps.
- Tests are intended to be deterministic: if you see flakiness, increase local timeouts temporarily and inspect logs.
